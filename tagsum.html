<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºå™¨å·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            display: flex;
            min-height: 500px;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden; /* ç¡®ä¿è¾¹æ¡†åŒ…å«æ‰€æœ‰å†…å®¹ */
            box-sizing: border-box;
        }
        
        .column {
            flex: 1;
            border-right: 1px solid #ccc;
            margin: 0;
            padding: 0;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .column:last-child {
            border-right: none;
        }
        
        .row-number-column {
            width: 120px;
            min-width: 80px;
            max-width: 200px;
            flex: none;
            border-right: 1px solid #ccc;
            margin: 0;
            padding: 0;
            min-height: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
            resize: horizontal;
            overflow: hidden;
        }

        .variety-column {
            width: 150px;
            min-width: 100px;
            max-width: 250px;
            flex: none;
            border-right: 1px solid #ccc;
            margin: 0;
            padding: 0;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
            resize: horizontal;
            overflow: hidden;
        }

        .column-resize-handle {
            position: absolute;
            right: -2px;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: col-resize;
            z-index: 1;
            background-color: transparent;
        }

        .column-resize-handle:hover {
            background-color: #2196F3;
        }
        
        .column-header {
            margin: 0;
            height: 40px; /* å›ºå®šæ ‡é¢˜é«˜åº¦ */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .column-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ccc;
            box-sizing: border-box;
        }
        
        .column-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 5px;
            box-sizing: border-box;
        }
        
        .column-button {
            padding: 8px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .column-button:hover {
            background-color: #0b7dda;
        }
        
        .column-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* æ·»åŠ æ»šåŠ¨æ¡ */
            max-height: calc(100vh - 250px); /* é™åˆ¶é«˜åº¦ï¼Œç¡®ä¿å¯ä»¥æ»šåŠ¨ */
            box-sizing: border-box;
        }
        
        .add-row-button {
            margin: 0 auto;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .add-row-button:hover {
            background-color: #45a049;
        }
        
        .row-number {
            display: flex;
            align-items: center; /* å‚ç›´å±…ä¸­ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            margin: 0;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0; /* é˜²æ­¢å‹ç¼© */
            height: 72px; /* å›ºå®šé«˜åº¦ä¸cellä¸€è‡´ */
            box-sizing: border-box;
            position: relative; /* ä¸ºåˆ é™¤æŒ‰é’®å®šä½ */
            border-bottom: 1px solid #ddd;
        }
        
        .row-number:hover::after {
            content: "Ã—";
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ff4444;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .row-number.editing {
            background-color: #d0d0d0;
        }
        
        .number-tag {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            margin: 3px;
            border-radius: 5px;
            cursor: move;
            user-select: none;
            position: relative;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .number-tag:hover::after {
            content: "Ã—";
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ff4444;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            box-sizing: border-box;
        }

        .number-tag.editing {
            cursor: text;
            outline: 2px solid #2196F3;
        }
        
        .cell {
            border-bottom: 1px solid #ddd;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            height: 72px; /* å›ºå®šé«˜åº¦ä»¥ç¡®ä¿å¯¹é½ */
            flex-shrink: 0; /* é˜²æ­¢å‹ç¼© */
            cursor: pointer; /* æ·»åŠ æŒ‡é’ˆæ ·å¼ï¼Œè¡¨æ˜å¯ç‚¹å‡» */
            box-sizing: border-box;
            overflow-y: auto; /* å…è®¸å†…å®¹æº¢å‡ºæ—¶æ»šåŠ¨ */
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
        }
        
        .sum-display {
            font-weight: bold;
            margin-top: 5px;
            color: #333;
            width: 100%;
            box-sizing: border-box;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }
        
        button {
            padding: 10px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-sizing: border-box;
        }
        
        button:hover {
            background-color: #0b7dda;
        }
        
        .number-tag.used {
            opacity: 0.6;
            cursor: default;
            background-color: #999;
        }
        
        .editable-title {
            cursor: pointer;
            position: relative;
        }
        
        .editable-title:hover::after {
            content: "âœ";
            position: absolute;
            font-size: 14px;
            margin-left: 8px;
            color: #2196F3;
        }
        
        .editable-title.editing {
            border: 2px solid #2196F3;
            padding: 5px;
            border-radius: 4px;
        }

        /* æ–°å¢å“ç§åˆ—ç¼–è¾‘æ ·å¼ */
        .editable-cell {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            min-height: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .editable-cell:hover {
            background-color: #f5f5f5;
        }
        .editable-cell::before {
            content: 'ç‚¹å‡»ç¼–è¾‘';
            position: absolute;
            color: #999;
            font-size: 12px;
            opacity: 0.6;
        }
        .editable-cell.editing {
            background-color: #fff;
            z-index: 100;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
        }
        .editable-cell.editing::before {
            display: none;
        }
        
        /* å›ºå®šæ§åˆ¶é¢æ¿æ ·å¼ */
        .fixed-controls {
            position: sticky;
            top: 0;
            background-color: #f8f8f8;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            height: 58px; /* å›ºå®šé«˜åº¦ç¡®ä¿å¯¹é½ */
        }
        
        .control-group {
            display: flex;
            align-items: center;
            box-sizing: border-box;
        }
        
        /* è‡ªå®šä¹‰è¾“å…¥æ¡†æ ·å¼ */
        .custom-input-popup {
            position: absolute;
            background-color: white;
            border: 2px solid #2196F3;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .custom-input-popup input {
            width: 100px;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .custom-input-popup .buttons {
            display: flex;
            justify-content: space-between;
            box-sizing: border-box;
        }
        
        .custom-input-popup button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .custom-input-popup .confirm-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .custom-input-popup .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        
        /* æ·»åŠ è¡Œç»„æ ·å¼ */
        .row-group {
            display: flex;
            width: 100%;
            margin: 0;
            box-sizing: border-box;
        }
        
        /* äº¤æ›¿è¡ŒèƒŒæ™¯è‰² */
        .row-group:nth-child(odd) .cell,
        .row-group:nth-child(odd) .row-number {
            background-color: #ffffff;
        }
        
        .row-group:nth-child(even) .cell,
        .row-group:nth-child(even) .row-number {
            background-color: #f9f9f9;
        }
        
        /* é¼ æ ‡æ‚¬åœé«˜äº®æ•´è¡Œ */
        .row-group:hover .cell,
        .row-group:hover .row-number {
            background-color: #e3f2fd;
        }
        
        /* å¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .export-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            margin-right: 10px; /* æ·»åŠ å³è¾¹è·ï¼Œä½¿æŒ‰é’®ä¹‹é—´æœ‰é—´éš” */
        }
        
        .export-btn:hover {
            background-color: #45a049;
        }
        
        .export-btn i {
            margin-right: 5px;
        }
        
        /* å¯¼å‡ºå›¾ç‰‡æŒ‰é’®æ ·å¼ */
        .export-img-btn {
            background-color: #2196F3;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            box-sizing: border-box;
        }
        
        .export-img-btn:hover {
            background-color: #0b7dda;
        }
        
        .export-img-btn i {
            margin-right: 5px;
        }
        
        /* æŒ‰é’®å®¹å™¨æ ·å¼ */
        .buttons-container {
            display: flex;
            align-items: center;
        }
        
        /* åŠ è½½ä¸­åŠ¨ç”»æ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* è¡¨æ ¼æ ‡é¢˜æ ·å¼ */
        .table-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
            cursor: pointer;
            position: relative;
        }
        
        .table-title:hover::after {
            content: "âœ";
            position: absolute;
            font-size: 18px;
            margin-left: 8px;
            color: #2196F3;
        }
        
        .table-title.editing {
            border: 2px solid #2196F3;
            padding: 5px;
            border-radius: 4px;
        }
        
        /* è¡¨æ ¼è¯´æ˜æ ·å¼ */
        .table-description {
            color: #666;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* ç¡®ä¿æ‰€æœ‰å…ƒç´ ä½¿ç”¨ç›¸åŒçš„ç›’æ¨¡å‹è®¡ç®— */
        * {
            box-sizing: border-box;
        }
    </style>
    <!-- æ·»åŠ html2canvasåº“ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
    <h1 class="table-title editable-title" id="main-title">æœºå™¨å·</h1>
    
    <div class="controls">
        <div class="table-description">
            <p>åœ¨äººå‘˜åˆ—ä¸­æ·»åŠ æ•°å­—æ ‡ç­¾ï¼Œç„¶åæ‹–æ‹½åˆ°åˆè®¡åˆ—è¿›è¡Œæ±‚å’Œ</p>
        </div>
        <div class="buttons-container">
            <button class="export-btn" id="export-excel">
                <i>ğŸ“Š</i> å¯¼å‡ºåˆ°Excel
            </button>
            <button class="export-img-btn" id="export-image">
                <i>ğŸ“·</i> ä¿å­˜ä¸ºå›¾ç‰‡
            </button>
        </div>
    </div>
    
    <div class="container">
        <div class="row-number-column" id="row-numbers">
            <h2 class="column-header">æ—¥æœŸ</h2>
            <div class="fixed-controls">
                <button class="add-row-button" id="add-row" title="æ·»åŠ æ–°è¡Œ">+</button>
            </div>
            <div class="column-content" id="row-numbers-content">
                <!-- æ—¥æœŸå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>
        
        <!-- åœ¨æ—¥æœŸåˆ—å³ä¾§æ–°å¢å“ç§åˆ— -->
        <div class="column" id="variety-column">
            <h2 class="column-header">å“ç§</h2>
            <div class="fixed-controls">
                <div style="height: 38px;"></div>
            </div>
            <div class="column-content" id="variety-content"></div>
        </div>

        <div class="column" id="column1">
            <h2 class="editable-title column-header" id="title1">äººå‘˜ä¸€</h2>
            <div class="fixed-controls">
                <div class="control-group">
                    <input type="text" id="column1-input" placeholder="æ•°å€¼" class="column-input">
                    <button id="add-to-column1" class="column-button">æ·»åŠ </button>
                </div>
            </div>
            <div class="column-content" id="column1-content"></div>
        </div>
        
        <div class="column" id="column2">
            <h2 class="editable-title column-header" id="title2">äººå‘˜äºŒ</h2>
            <div class="fixed-controls">
                <div class="control-group">
                    <input type="text" id="column2-input" placeholder="æ•°å€¼" class="column-input">
                    <button id="add-to-column2" class="column-button">æ·»åŠ </button>
                </div>
            </div>
            <div class="column-content" id="column2-content"></div>
        </div>
        
        <div class="column" id="column3">
            <h2 class="column-header">åˆè®¡</h2>
            <div class="fixed-controls">
                <!-- ç©ºçš„æ§åˆ¶åŒºåŸŸï¼Œç”¨äºä¿æŒå¯¹é½ -->
                <div style="height: 38px;"></div>
            </div>
            <div class="column-content" id="column3-content"></div>
        </div>
    </div>
    
    <script>
        // æ·»åŠ é¡µé¢å…³é—­æˆ–åˆ·æ–°å‰çš„ç¡®è®¤æç¤º
        window.addEventListener('beforeunload', function(e) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®éœ€è¦ä¿å­˜
            const hasData = checkForData();
            
            if (hasData) {
                // æ ‡å‡†çš„ç¡®è®¤æ¶ˆæ¯
                const confirmationMessage = 'æ‚¨æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                
                // ä¸åŒæµè§ˆå™¨å¤„ç†æ–¹å¼ä¸åŒï¼Œéœ€è¦åŒæ—¶è®¾ç½®returnValueå’Œè¿”å›å€¼
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®éœ€è¦ä¿å­˜
        function checkForData() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ•°å­—æ ‡ç­¾
            const tags = document.querySelectorAll('.number-tag');
            if (tags.length > 0) {
                return true;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æ ‡é¢˜
            const mainTitle = document.getElementById('main-title');
            if (mainTitle && mainTitle.textContent !== 'æœºå™¨å·') {
                return true;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†åˆ—æ ‡é¢˜
            const title1 = document.getElementById('title1');
            const title2 = document.getElementById('title2');
            if ((title1 && title1.textContent !== 'äººå‘˜ä¸€') || 
                (title2 && title2.textContent !== 'äººå‘˜äºŒ')) {
                return true;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¤šäºä¸€è¡Œçš„æ•°æ®
            const rows = document.querySelectorAll('.row-group');
            if (rows.length > 1) {
                return true;
            }
            
            return false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();
            
            // æ·»åŠ æ–°è¡ŒæŒ‰é’®
            document.getElementById('add-row').addEventListener('click', function() {
                addNewRow();
            });
            
            // æ·»åŠ åˆ°ç¬¬ä¸€åˆ—æŒ‰é’®
            document.getElementById('add-to-column1').addEventListener('click', function() {
                addCustomTag('column1-input', 'column1');
            });
            
            // æ·»åŠ åˆ°ç¬¬äºŒåˆ—æŒ‰é’®
            document.getElementById('add-to-column2').addEventListener('click', function() {
                addCustomTag('column2-input', 'column2');
            });
            
            // æ·»åŠ æ ‡é¢˜ç¼–è¾‘åŠŸèƒ½
            initTitleEditing();
            
            // æ·»åŠ åˆå§‹è¡Œ
            addNewRow();
            
            // æ·»åŠ æ»šåŠ¨åŒæ­¥åŠŸèƒ½
            initScrollSync();
            
            // æ·»åŠ å¯¼å‡ºåˆ°ExcelåŠŸèƒ½
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            
            // æ·»åŠ å¯¼å‡ºä¸ºå›¾ç‰‡åŠŸèƒ½
            document.getElementById('export-image').addEventListener('click', exportToImage);
            
            // æ·»åŠ ä¸»æ ‡é¢˜ç¼–è¾‘åŠŸèƒ½
            const mainTitle = document.getElementById('main-title');
            if (mainTitle) {
                mainTitle.addEventListener('click', function() {
                    // å¦‚æœå·²ç»åœ¨ç¼–è¾‘ä¸­ï¼Œä¸åšä»»ä½•æ“ä½œ
                    if (mainTitle.classList.contains('editing')) {
                        return;
                    }
                    
                    // ä¿å­˜åŸå§‹æ–‡æœ¬
                    const originalText = mainTitle.textContent;
                    mainTitle.classList.add('editing');
                    
                    // åˆ›å»ºè¾“å…¥æ¡†
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = originalText;
                    input.style.width = '300px';
                    input.style.fontSize = '24px';
                    input.style.fontWeight = 'bold';
                    input.style.padding = '5px';
                    input.style.border = 'none';
                    input.style.outline = 'none';
                    input.style.backgroundColor = 'transparent';
                    input.style.textAlign = 'center';
                    
                    // æ¸…ç©ºæ ‡é¢˜å†…å®¹å¹¶æ·»åŠ è¾“å…¥æ¡†
                    mainTitle.textContent = '';
                    mainTitle.appendChild(input);
                    input.focus();
                    
                    // å¤„ç†è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹äº‹ä»¶
                    input.addEventListener('blur', finishEditing);
                    
                    // å¤„ç†å›è½¦é”®
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            finishEditing();
                        }
                    });
                    
                    // å®Œæˆç¼–è¾‘çš„å‡½æ•°
                    function finishEditing() {
                        const newText = input.value.trim();
                        mainTitle.classList.remove('editing');
                        
                        // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ¢å¤åŸå§‹æ–‡æœ¬
                        if (newText === '') {
                            mainTitle.textContent = originalText;
                        } else {
                            mainTitle.textContent = newText;
                            // æ›´æ–°é¡µé¢æ ‡é¢˜
                            document.title = newText;
                        }
                    }
                });
            }
        });
        
        // æ·»åŠ å…¨å±€å˜é‡æ¥è·Ÿè¸ªå½“å‰æ‹–åŠ¨çš„æºæ ‡ç­¾
        window.currentDragSourceId = null;
        
        function initDragAndDrop() {
            const numberTags = document.querySelectorAll('.number-tag');
            const cells = document.querySelectorAll('.cell');
            
            // ä¸ºæ•°å­—æ ‡ç­¾æ·»åŠ æ‹–æ‹½äº‹ä»¶
            numberTags.forEach(tag => {
                tag.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', tag.dataset.value);
                    e.dataTransfer.setData('sourceId', tag.id);
                    // å­˜å‚¨å½“å‰æ‹–åŠ¨çš„æ ‡ç­¾IDåˆ°å…¨å±€å˜é‡
                    window.currentDragSourceId = tag.id;
                });
                
                tag.addEventListener('dragend', function() {
                    // æ¸…é™¤å…¨å±€å˜é‡
                    window.currentDragSourceId = null;
                });
            });
            
            // ä¸ºå•å…ƒæ ¼æ·»åŠ æ”¾ç½®äº‹ä»¶
            cells.forEach(cell => {
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºç›´æ¥åˆ›å»ºæ ‡ç­¾ï¼ˆä»…ç¬¬ä¸€åˆ—å’Œç¬¬äºŒåˆ—ï¼‰
                if (cell.id && (cell.id.startsWith('cell1-') || cell.id.startsWith('cell2-'))) {
                    cell.addEventListener('click', function(e) {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯å•å…ƒæ ¼è€Œä¸æ˜¯å…¶ä¸­çš„æ ‡ç­¾
                        if (e.target === cell) {
                            const columnNumber = cell.id.startsWith('cell1-') ? 1 : 2;
                            promptAndAddTag(cell, columnNumber);
                        }
                    });
                }
                
                cell.addEventListener('dragover', function(e) {
                    // è·å–è¢«æ‹–åŠ¨çš„æ ‡ç­¾æ¥æºä¿¡æ¯
                    const sourceId = e.dataTransfer.getData('sourceId');
                    let sourceTag = null;
                    let sourceColumn = null;
                    
                    // åœ¨dragoveräº‹ä»¶ä¸­æ— æ³•ç›´æ¥è·å–dataTransferæ•°æ®ï¼Œæ‰€ä»¥ä½¿ç”¨å…¨å±€å˜é‡
                    if (window.currentDragSourceId) {
                        sourceTag = document.getElementById(window.currentDragSourceId);
                        if (sourceTag) {
                            // ç¡®å®šæºæ ‡ç­¾æ‰€åœ¨çš„åˆ—
                            const parentCell = sourceTag.closest('.cell');
                            if (parentCell) {
                                if (parentCell.id.startsWith('cell1-')) {
                                    sourceColumn = 1;
                                } else if (parentCell.id.startsWith('cell2-')) {
                                    sourceColumn = 2;
                                }
                            }
                        }
                    }
                    
                    // ç¡®å®šç›®æ ‡å•å…ƒæ ¼æ‰€åœ¨çš„åˆ—
                    let targetColumn = null;
                    if (cell.id.startsWith('cell1-')) {
                        targetColumn = 1;
                    } else if (cell.id.startsWith('cell2-')) {
                        targetColumn = 2;
                    } else if (cell.id.startsWith('cell3-')) {
                        targetColumn = 3;
                    }
                    
                    // å…è®¸ä»¥ä¸‹æƒ…å†µæ”¾ç½®ï¼š
                    // 1. ç¬¬ä¸€åˆ—æ‹–åˆ°ç¬¬ä¸‰åˆ—
                    // 2. ç¬¬äºŒåˆ—æ‹–åˆ°ç¬¬ä¸‰åˆ—
                    // 3. åŒä¸€åˆ—å†…çš„ä¸åŒè¡Œä¹‹é—´ç§»åŠ¨
                    const allowDrop = 
                        (sourceColumn === 1 && targetColumn === 3) || 
                        (sourceColumn === 2 && targetColumn === 3) ||
                        (sourceColumn === targetColumn); // å…è®¸åŒåˆ—ä¸åŒè¡Œ
                    
                    if (allowDrop) {
                    e.preventDefault(); // å…è®¸æ”¾ç½®
                        // æ·»åŠ è§†è§‰åé¦ˆ
                        cell.style.backgroundColor = '#e3f2fd';
                    }
                });
                
                // æ·»åŠ dragenteräº‹ä»¶å¤„ç†
                cell.addEventListener('dragenter', function(e) {
                    const sourceTag = document.getElementById(window.currentDragSourceId);
                    if (sourceTag) {
                        const sourceCell = sourceTag.closest('.cell');
                        const sourceColumn = sourceCell.id.startsWith('cell1-') ? 1 : 
                                          sourceCell.id.startsWith('cell2-') ? 2 : 3;
                        
                        const targetColumn = cell.id.startsWith('cell1-') ? 1 : 
                                          cell.id.startsWith('cell2-') ? 2 : 3;
                                          
                        if (sourceColumn === targetColumn || 
                            (sourceColumn !== 3 && targetColumn === 3)) {
                            cell.style.backgroundColor = '#e3f2fd';
                        }
                    }
                });
                
                // æ·»åŠ dragleaveäº‹ä»¶å¤„ç†
                cell.addEventListener('dragleave', function(e) {
                    cell.style.backgroundColor = '#f9f9f9';
                });
                
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    // æ¢å¤å•å…ƒæ ¼èƒŒæ™¯è‰²
                    cell.style.backgroundColor = '#f9f9f9';
                    
                    const value = e.dataTransfer.getData('text/plain');
                    const sourceId = e.dataTransfer.getData('sourceId');
                    const sourceTag = document.getElementById(sourceId);
                    
                    // å¦‚æœæ˜¯åŒä¸€åˆ—å†…çš„ç§»åŠ¨ï¼Œç›´æ¥ç§»åŠ¨åŸæ ‡ç­¾
                    if (sourceTag && 
                        ((cell.id.startsWith('cell1-') && sourceTag.closest('.cell').id.startsWith('cell1-')) ||
                         (cell.id.startsWith('cell2-') && sourceTag.closest('.cell').id.startsWith('cell2-')))) {
                        cell.appendChild(sourceTag);
                        return;
                    }
                    
                    // åˆ›å»ºæ–°æ ‡ç­¾
                    const newTag = document.createElement('div');
                    newTag.className = 'number-tag';
                    newTag.textContent = value;
                    newTag.dataset.value = value;
                    
                    // å¦‚æœæ˜¯æ‹–åˆ°ç¬¬ä¸‰åˆ—ï¼Œç¦ç”¨æºæ ‡ç­¾çš„æ‹–åŠ¨
                    if(cell.id.startsWith('cell3') && sourceId) {
                        // æ‰¾åˆ°æºæ ‡ç­¾å¹¶ç¦ç”¨æ‹–åŠ¨
                        const sourceTag = document.getElementById(sourceId);
                        if(sourceTag) {
                            sourceTag.draggable = false;
                            sourceTag.classList.add('used');
                            sourceTag.style.opacity = '0.6';
                            sourceTag.style.cursor = 'default';
                            sourceTag.title = 'å·²ä½¿ç”¨ï¼Œåˆ é™¤ç¬¬ä¸‰åˆ—ä¸­çš„æ ‡ç­¾åå¯å†æ¬¡ä½¿ç”¨';
                            
                            // å­˜å‚¨å…³è”ä¿¡æ¯
                            const uniqueId = Date.now() + Math.random().toString(36).substr(2, 5);
                            sourceTag.dataset.linkedId = uniqueId;
                            newTag.dataset.linkedId = uniqueId;
                            newTag.dataset.sourceId = sourceId;
                        }
                    }
                    
                    // ç¬¬ä¸‰åˆ—çš„æ ‡ç­¾ä¸å¯æ‹–åŠ¨
                    if(cell.id.startsWith('cell3')) {
                        newTag.draggable = false;
                        // æ·»åŠ è§†è§‰æç¤ºï¼Œè¡¨æ˜ä¸å¯æ‹–åŠ¨
                        newTag.style.cursor = 'default';
                        newTag.title = 'ç‚¹å‡»åˆ é™¤æŒ‰é’®ç§»é™¤';
                    } else {
                        newTag.draggable = true;
                    }
                    
                    // æ·»åŠ åˆ é™¤åŠŸèƒ½
                    newTag.addEventListener('click', function(e) {
                        const rect = newTag.getBoundingClientRect();
                        const isClickOnDeleteButton = 
                            e.clientX >= rect.right - 20 && 
                            e.clientX <= rect.right + 10 && 
                            e.clientY >= rect.top - 10 && 
                            e.clientY <= rect.top + 20;

                        if (isClickOnDeleteButton) {
                            e.stopPropagation();
                            
                            // å¦‚æœåœ¨ç¬¬ä¸‰åˆ—ä¸­è¢«åˆ é™¤ï¼Œæ¢å¤æºæ ‡ç­¾çš„æ‹–åŠ¨åŠŸèƒ½
                            if(cell.id.startsWith('cell3') && newTag.dataset.sourceId) {
                                const sourceTag = document.getElementById(newTag.dataset.sourceId);
                                if(sourceTag) {
                                    sourceTag.draggable = true;
                                    sourceTag.classList.remove('used');
                                    sourceTag.style.opacity = '1';
                                    sourceTag.style.cursor = 'move';
                                    sourceTag.title = '';
                                    delete sourceTag.dataset.linkedId;
                                }
                            }
                            
                        newTag.remove();
                            // åªæœ‰åœ¨ç¬¬ä¸‰åˆ—éœ€è¦æ›´æ–°æ€»å’Œ
                            if(cell.id.startsWith('cell3')) {
                        updateSum(cell);
                            }
                        }
                    });
                    
                    // å¦‚æœæ˜¯ç¬¬ä¸‰åˆ—ï¼Œéœ€è¦åœ¨sum-displayå‰æ’å…¥
                    if(cell.id.startsWith('cell3')) {
                    cell.insertBefore(newTag, cell.querySelector('.sum-display'));
                    updateSum(cell);
                    } else {
                        cell.appendChild(newTag);
                    }
                });
            });
        }
        
        function updateSum(cell) {
            const tags = cell.querySelectorAll('.number-tag');
            let sum = 0;
            
            tags.forEach(tag => {
                // ä½¿ç”¨parseFloatä»£æ›¿parseIntä»¥æ”¯æŒå°æ•°
                sum += parseFloat(tag.dataset.value);
            });
            
            const sumDisplay = cell.querySelector('.sum-display');
            // æ€»å’Œä¿ç•™ä¸€ä½å°æ•°
            sumDisplay.textContent = `æ€»å’Œ: ${sum.toFixed(1)}`;
        }
        
        function addNewRow() {
            // è·å–è¡Œæ•°
            const cellCount = document.querySelectorAll('.cell').length / 3; // é™¤ä»¥3å› ä¸ºæ¯è¡Œæœ‰3ä¸ªå•å…ƒæ ¼
            const rowId = cellCount + 1;
            
            // åˆ›å»ºè¡Œç»„å®¹å™¨
            const rowGroup = document.createElement('div');
            rowGroup.className = 'row-group';
            rowGroup.id = `row-group-${rowId}`;
            rowGroup.dataset.rowId = rowId;
            
            // ä¸ºæ—¥æœŸåˆ—æ·»åŠ æ–°æ—¥æœŸ
            const newRowNumber = document.createElement('div');
            newRowNumber.className = 'row-number';
            newRowNumber.id = `row-number-${rowId}`;
            newRowNumber.style.height = '72px'; // ç¡®ä¿ä¸å•å…ƒæ ¼é«˜åº¦ä¸€è‡´
            newRowNumber.style.boxSizing = 'border-box';
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæœ€åä¸€ä¸ªæ—¥æœŸçš„åä¸€å¤©ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ä»Šå¤©
            let dateStr;
            const existingDates = document.querySelectorAll('.row-number');
            if (existingDates.length > 0) {
                const lastDate = existingDates[existingDates.length - 1].dataset.date;
                const nextDate = getNextDay(lastDate);
                dateStr = nextDate;
            } else {
                const today = new Date();
                dateStr = today.toISOString().split('T')[0]; // æ ¼å¼ï¼šYYYY-MM-DD
            }
            
            // å­˜å‚¨å®Œæ•´æ—¥æœŸï¼Œä½†æ˜¾ç¤ºæœˆ-æ—¥æ ¼å¼
            newRowNumber.textContent = formatDateToMonthDay(dateStr);
            newRowNumber.dataset.date = dateStr;
            newRowNumber.dataset.rowId = rowId; // å­˜å‚¨è¡ŒIDç”¨äºåˆ é™¤æ•´è¡Œ
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºç¼–è¾‘æ—¥æœŸ
            newRowNumber.addEventListener('click', function(e) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†åˆ é™¤æŒ‰é’®
                const rect = newRowNumber.getBoundingClientRect();
                const isClickOnDeleteButton = 
                    e.clientX >= rect.right - 20 && 
                    e.clientX <= rect.right + 10 && 
                    e.clientY >= rect.top - 10 && 
                    e.clientY <= rect.top + 20;
                
                if (isClickOnDeleteButton) {
                    e.stopPropagation();
                    deleteEntireRow(rowId);
                } else {
                    editRowDate(newRowNumber);
                }
            });
            
            // ä¸ºç¬¬ä¸€åˆ—æ·»åŠ æ–°è¡Œ
            const newRow1 = document.createElement('div');
            newRow1.className = 'cell';
            newRow1.id = `cell1-${rowId}`;
            newRow1.dataset.rowId = rowId; // å­˜å‚¨è¡ŒIDç”¨äºåˆ é™¤æ•´è¡Œ
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºç›´æ¥åˆ›å»ºæ ‡ç­¾
            newRow1.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å•å…ƒæ ¼è€Œä¸æ˜¯å…¶ä¸­çš„æ ‡ç­¾
                if (e.target === newRow1) {
                    promptAndAddTag(newRow1, 1);
                }
            });
            
            // ä¸ºç¬¬äºŒåˆ—æ·»åŠ æ–°è¡Œ
            const newRow2 = document.createElement('div');
            newRow2.className = 'cell';
            newRow2.id = `cell2-${rowId}`;
            newRow2.dataset.rowId = rowId; // å­˜å‚¨è¡ŒIDç”¨äºåˆ é™¤æ•´è¡Œ
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºç›´æ¥åˆ›å»ºæ ‡ç­¾
            newRow2.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å•å…ƒæ ¼è€Œä¸æ˜¯å…¶ä¸­çš„æ ‡ç­¾
                if (e.target === newRow2) {
                    promptAndAddTag(newRow2, 2);
                }
            });
            
            // ä¸ºç¬¬ä¸‰åˆ—æ·»åŠ æ–°è¡Œ
            const newRow3 = document.createElement('div');
            newRow3.className = 'cell';
            newRow3.id = `cell3-${rowId}`;
            newRow3.dataset.rowId = rowId; // å­˜å‚¨è¡ŒIDç”¨äºåˆ é™¤æ•´è¡Œ
            
            const sumDisplay = document.createElement('div');
            sumDisplay.className = 'sum-display';
            sumDisplay.textContent = 'æ€»å’Œ: 0';
            
            newRow3.appendChild(sumDisplay);
            
            // å°†æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°è¡Œç»„
            rowGroup.appendChild(newRowNumber);
            
            // å°†è¡Œç»„æ·»åŠ åˆ°æ—¥æœŸåˆ—å†…å®¹åŒºåŸŸ
            document.getElementById('row-numbers-content').appendChild(rowGroup);
            
            // å°†å•å…ƒæ ¼æ·»åŠ åˆ°å„è‡ªçš„åˆ—
            document.getElementById('column1-content').appendChild(newRow1);
            document.getElementById('column2-content').appendChild(newRow2);
            document.getElementById('column3-content').appendChild(newRow3);
            
            // ä¸ºæ‰€æœ‰æ–°å•å…ƒæ ¼æ·»åŠ æ‹–æ”¾åŠŸèƒ½
            [newRow1, newRow2, newRow3].forEach(cell => {
                cell.addEventListener('dragover', function(e) {
                    // è·å–è¢«æ‹–åŠ¨çš„æ ‡ç­¾æ¥æºä¿¡æ¯
                    let sourceColumn = null;
                    
                    // ä½¿ç”¨å…¨å±€å˜é‡è·å–å½“å‰æ‹–åŠ¨çš„æ ‡ç­¾
                    if (window.currentDragSourceId) {
                        const sourceTag = document.getElementById(window.currentDragSourceId);
                        if (sourceTag) {
                            // ç¡®å®šæºæ ‡ç­¾æ‰€åœ¨çš„åˆ—
                            const parentCell = sourceTag.closest('.cell');
                            if (parentCell) {
                                if (parentCell.id.startsWith('cell1-')) {
                                    sourceColumn = 1;
                                } else if (parentCell.id.startsWith('cell2-')) {
                                    sourceColumn = 2;
                                }
                            }
                        }
                    }
                    
                    // ç¡®å®šç›®æ ‡å•å…ƒæ ¼æ‰€åœ¨çš„åˆ—
                    let targetColumn = null;
                    if (cell.id.startsWith('cell1-')) {
                        targetColumn = 1;
                    } else if (cell.id.startsWith('cell2-')) {
                        targetColumn = 2;
                    } else if (cell.id.startsWith('cell3-')) {
                        targetColumn = 3;
                    }
                    
                    // å…è®¸ä»¥ä¸‹æƒ…å†µæ”¾ç½®ï¼š
                    // 1. ç¬¬ä¸€åˆ—æ‹–åˆ°ç¬¬ä¸‰åˆ—
                    // 2. ç¬¬äºŒåˆ—æ‹–åˆ°ç¬¬ä¸‰åˆ—
                    // 3. åŒä¸€åˆ—å†…çš„ä¸åŒè¡Œä¹‹é—´ç§»åŠ¨
                    const allowDrop = 
                        (sourceColumn === 1 && targetColumn === 3) || 
                        (sourceColumn === 2 && targetColumn === 3) ||
                        (sourceColumn === targetColumn); // å…è®¸åŒåˆ—ä¸åŒè¡Œ
                    
                    if (allowDrop) {
                        e.preventDefault(); // å…è®¸æ”¾ç½®
                        // æ·»åŠ è§†è§‰åé¦ˆ
                        cell.style.backgroundColor = '#e3f2fd';
                    }
                });
                
                // æ·»åŠ dragenteräº‹ä»¶å¤„ç†
                cell.addEventListener('dragenter', function(e) {
                    const sourceTag = document.getElementById(window.currentDragSourceId);
                    if (sourceTag) {
                        const sourceCell = sourceTag.closest('.cell');
                        const sourceColumn = sourceCell.id.startsWith('cell1-') ? 1 : 
                                          sourceCell.id.startsWith('cell2-') ? 2 : 3;
                        
                        const targetColumn = cell.id.startsWith('cell1-') ? 1 : 
                                          cell.id.startsWith('cell2-') ? 2 : 3;
                                          
                        if (sourceColumn === targetColumn || 
                            (sourceColumn !== 3 && targetColumn === 3)) {
                            cell.style.backgroundColor = '#e3f2fd';
                        }
                    }
                });
                
                // æ·»åŠ dragleaveäº‹ä»¶å¤„ç†
                cell.addEventListener('dragleave', function(e) {
                    cell.style.backgroundColor = '#f9f9f9';
                });
                
                cell.addEventListener('drop', function(e) {
                e.preventDefault();
                    // æ¢å¤å•å…ƒæ ¼èƒŒæ™¯è‰²
                    cell.style.backgroundColor = '#f9f9f9';
                    
                const value = e.dataTransfer.getData('text/plain');
                    const sourceId = e.dataTransfer.getData('sourceId');
                    const sourceTag = document.getElementById(sourceId);
                    
                    // å¦‚æœæ˜¯åŒä¸€åˆ—å†…çš„ç§»åŠ¨ï¼Œç›´æ¥ç§»åŠ¨åŸæ ‡ç­¾
                    if (sourceTag && 
                        ((cell.id.startsWith('cell1-') && sourceTag.closest('.cell').id.startsWith('cell1-')) ||
                         (cell.id.startsWith('cell2-') && sourceTag.closest('.cell').id.startsWith('cell2-')))) {
                        cell.appendChild(sourceTag);
                        return;
                    }
                    
                    // åˆ›å»ºæ–°æ ‡ç­¾
                const newTag = document.createElement('div');
                newTag.className = 'number-tag';
                newTag.textContent = value;
                newTag.dataset.value = value;
                
                    // å¦‚æœæ˜¯æ‹–åˆ°ç¬¬ä¸‰åˆ—ï¼Œç¦ç”¨æºæ ‡ç­¾çš„æ‹–åŠ¨
                    if(cell.id.startsWith('cell3') && sourceId) {
                        // æ‰¾åˆ°æºæ ‡ç­¾å¹¶ç¦ç”¨æ‹–åŠ¨
                        const sourceTag = document.getElementById(sourceId);
                        if(sourceTag) {
                            sourceTag.draggable = false;
                            sourceTag.classList.add('used');
                            sourceTag.style.opacity = '0.6';
                            sourceTag.style.cursor = 'default';
                            sourceTag.title = 'å·²ä½¿ç”¨ï¼Œåˆ é™¤ç¬¬ä¸‰åˆ—ä¸­çš„æ ‡ç­¾åå¯å†æ¬¡ä½¿ç”¨';
                            
                            // å­˜å‚¨å…³è”ä¿¡æ¯
                            const uniqueId = Date.now() + Math.random().toString(36).substr(2, 5);
                            sourceTag.dataset.linkedId = uniqueId;
                            newTag.dataset.linkedId = uniqueId;
                            newTag.dataset.sourceId = sourceId;
                        }
                    }
                    
                    // ç¬¬ä¸‰åˆ—çš„æ ‡ç­¾ä¸å¯æ‹–åŠ¨
                    if(cell.id.startsWith('cell3')) {
                        newTag.draggable = false;
                        // æ·»åŠ è§†è§‰æç¤ºï¼Œè¡¨æ˜ä¸å¯æ‹–åŠ¨
                        newTag.style.cursor = 'default';
                        newTag.title = 'ç‚¹å‡»åˆ é™¤æŒ‰é’®ç§»é™¤';
                    } else {
                        newTag.draggable = true;
                    }
                    
                    // æ·»åŠ åˆ é™¤åŠŸèƒ½
                    newTag.addEventListener('click', function(e) {
                        const rect = newTag.getBoundingClientRect();
                        const isClickOnDeleteButton = 
                            e.clientX >= rect.right - 20 && 
                            e.clientX <= rect.right + 10 && 
                            e.clientY >= rect.top - 10 && 
                            e.clientY <= rect.top + 20;

                        if (isClickOnDeleteButton) {
                            e.stopPropagation();
                            
                            // å¦‚æœåœ¨ç¬¬ä¸‰åˆ—ä¸­è¢«åˆ é™¤ï¼Œæ¢å¤æºæ ‡ç­¾çš„æ‹–åŠ¨åŠŸèƒ½
                            const parentCell = newTag.closest('.cell');
                            if (parentCell && parentCell.id.startsWith('cell3') && newTag.dataset.sourceId) {
                                const sourceTag = document.getElementById(newTag.dataset.sourceId);
                                if(sourceTag) {
                                    sourceTag.draggable = true;
                                    sourceTag.classList.remove('used');
                                    sourceTag.style.opacity = '1';
                                    sourceTag.style.cursor = 'move';
                                    sourceTag.title = '';
                                    delete sourceTag.dataset.linkedId;
                                }
                            }
                            
                    newTag.remove();
                            // å¦‚æœåœ¨ç¬¬ä¸‰åˆ—ä¸­ï¼Œæ›´æ–°æ€»å’Œ
                            if (parentCell && parentCell.id.startsWith('cell3')) {
                                updateSum(parentCell);
                            }
                        }
                    });
                    
                    // å¦‚æœæ˜¯ç¬¬ä¸‰åˆ—çš„å•å…ƒæ ¼ï¼Œåœ¨sum-displayå‰æ’å…¥
                    const sumDisplay = cell.querySelector('.sum-display');
                    if (sumDisplay) {
                        cell.insertBefore(newTag, sumDisplay);
                        updateSum(cell);
                    } else {
                        cell.appendChild(newTag);
                    }
                });
            });
            
            // æ–°å¢è¡Œæ—¶ä¸ºå“ç§åˆ—æ·»åŠ å•å…ƒæ ¼
            addVarietyCell(rowId);
        }
        
        // æ–°å¢è¡Œæ—¶ä¸ºå“ç§åˆ—æ·»åŠ å•å…ƒæ ¼
        function addVarietyCell(rowId) {
            const varietyColumn = document.getElementById('variety-column').querySelector('.column-content');
            const newVarietyCell = document.createElement('div');
            newVarietyCell.className = 'cell editable-cell';
            newVarietyCell.id = `variety-cell-${rowId}`;
            newVarietyCell.dataset.rowId = rowId;

            // é»˜è®¤å†…å®¹ä¸ä¸Šä¸€å•å…ƒæ ¼ä¸€è‡´
            const previousCells = varietyColumn.querySelectorAll('.cell');
            if (previousCells.length > 0) {
                newVarietyCell.textContent = previousCellContent(varietyColumn);
            } else {
                newVarietyCell.textContent = 'ç‚¹å‡»ç¼–è¾‘';
            }

            newVarietyCell.addEventListener('click', function() {
                editVarietyCell(newVarietyCell);
            });

            varietyColumn.appendChild(newVarietyCell);
        }

        // è·å–ä¸Šä¸€ä¸ªå•å…ƒæ ¼å†…å®¹
        function previousCellContent(column) {
            const cells = column.querySelectorAll('.cell');
            return cells[cells.length - 1].textContent;
        }

        // ç¼–è¾‘å“ç§å•å…ƒæ ¼ - æ–°ç‰ˆ
        function editVarietyCell(cell) {
            if (cell.classList.contains('editing')) return;

            const originalText = cell.textContent;
            cell.classList.add('editing');

            // åˆ›å»ºå¸¦è‡ªåŠ¨é«˜åº¦çš„æ–‡æœ¬åŸŸ
            const textarea = document.createElement('textarea');
            textarea.value = originalText.trim();
            textarea.style.width = '100%';
            textarea.style.minHeight = '60px';
            textarea.style.border = '2px solid #2196F3';
            textarea.style.borderRadius = '4px';
            textarea.style.padding = '8px';
            textarea.style.resize = 'none';
            textarea.style.boxSizing = 'border-box';
            
            // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            const adjustHeight = () => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            };
            textarea.addEventListener('input', adjustHeight);
            
            // æ¸…ç©ºå•å…ƒæ ¼å†…å®¹å¹¶æ·»åŠ æ–‡æœ¬åŸŸ
            cell.textContent = '';
            cell.appendChild(textarea);
            textarea.focus();
            adjustHeight();

            // ä¿å­˜å‡½æ•°
            const saveChanges = () => {
                const newText = textarea.value.trim();
                cell.textContent = newText || 'ç‚¹å‡»ç¼–è¾‘';
                cell.classList.remove('editing');
                
                // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œæ¢å¤æç¤ºæ–‡å­—
                if (!newText) {
                    cell.textContent = 'ç‚¹å‡»ç¼–è¾‘';
                }
            };

            // å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
            textarea.addEventListener('blur', saveChanges);

            // å›è½¦é”®ä¿å­˜ï¼ˆCtrl+Enteræ¢è¡Œï¼‰
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.ctrlKey) {
                    e.preventDefault();
                    saveChanges();
                }
            });

            // ESCé”®å–æ¶ˆç¼–è¾‘
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    cell.textContent = originalText;
                    cell.classList.remove('editing');
                }
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹ä¿å­˜
            document.addEventListener('click', function onClickOutside(e) {
                if (!cell.contains(e.target)) {
                    saveChanges();
                    document.removeEventListener('click', onClickOutside);
                }
            }, { once: true });
        }

        // è·å–ä¸‹ä¸€å¤©çš„æ—¥æœŸ
        function getNextDay(dateString) {
            const date = new Date(dateString);
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸º"MM-DD"æ ¼å¼
        function formatDateToMonthDay(dateString) {
            const date = new Date(dateString);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
        }
        
        // ç¼–è¾‘å•ä¸ªæ—¥æœŸ
        function editRowDate(dateElement) {
            if (dateElement.classList.contains('editing')) {
                return;
            }
            
            const originalValue = dateElement.dataset.date; // ä½¿ç”¨å®Œæ•´æ—¥æœŸæ ¼å¼
            dateElement.classList.add('editing');
            
            // åˆ›å»ºæ—¥æœŸé€‰æ‹©å™¨å®¹å™¨
            const datePickerContainer = document.createElement('div');
            datePickerContainer.style.position = 'relative';
            datePickerContainer.style.width = '100%';
            datePickerContainer.style.height = '100%';
            
            // åˆ›å»ºæ—¥æœŸè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'date';
            input.value = originalValue;
            input.style.width = '100%';
            input.style.padding = '5px';
            input.style.border = 'none';
            input.style.borderRadius = '3px';
            input.style.boxSizing = 'border-box';
            
            // æ·»åŠ æ—¥æœŸé€‰æ‹©å™¨å›¾æ ‡
            const calendarIcon = document.createElement('div');
            calendarIcon.innerHTML = 'ğŸ“…';
            calendarIcon.style.position = 'absolute';
            calendarIcon.style.right = '5px';
            calendarIcon.style.top = '50%';
            calendarIcon.style.transform = 'translateY(-50%)';
            calendarIcon.style.cursor = 'pointer';
            calendarIcon.style.fontSize = '16px';
            
            // ç‚¹å‡»å›¾æ ‡æ—¶æ‰“å¼€æ—¥æœŸé€‰æ‹©å™¨
            calendarIcon.addEventListener('click', function() {
                input.showPicker();
            });
            
            // æ¸…ç©ºæ—¥æœŸå†…å®¹å¹¶æ·»åŠ è¾“å…¥æ¡†å’Œå›¾æ ‡
            dateElement.textContent = '';
            datePickerContainer.appendChild(input);
            datePickerContainer.appendChild(calendarIcon);
            dateElement.appendChild(datePickerContainer);
            
            // èšç„¦è¾“å…¥æ¡†
            input.focus();
            
            // å¤„ç†è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹äº‹ä»¶
            input.addEventListener('blur', finishEditing);
            
            // å¤„ç†è¾“å…¥æ¡†å˜åŒ–äº‹ä»¶
            input.addEventListener('change', function() {
                finishEditing();
            });
            
            // å¤„ç†å›è½¦é”®
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    finishEditing();
                }
            });
            
            // å®Œæˆç¼–è¾‘çš„å‡½æ•°
            function finishEditing() {
                const newValue = input.value;
                dateElement.classList.remove('editing');
                
                // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ¢å¤åŸå§‹å€¼
                if (newValue === '') {
                    dateElement.textContent = formatDateToMonthDay(originalValue);
                    dateElement.dataset.date = originalValue;
                } else {
                    // å¦‚æœæ—¥æœŸæœ‰å˜åŒ–ï¼Œæ›´æ–°å½“å‰æ—¥æœŸå¹¶è°ƒæ•´åç»­æ—¥æœŸ
                    if (newValue !== originalValue) {
                        dateElement.textContent = formatDateToMonthDay(newValue);
                        dateElement.dataset.date = newValue;
                        
                        // è·å–æ‰€æœ‰æ—¥æœŸå…ƒç´ 
                        const rowNumbersColumn = document.getElementById('row-numbers').querySelector('.column-content');
                        const allDateElements = Array.from(rowNumbersColumn.querySelectorAll('.row-number'));
                        
                        // æ‰¾åˆ°å½“å‰æ—¥æœŸå…ƒç´ çš„ç´¢å¼•
                        const currentIndex = allDateElements.indexOf(dateElement);
                        
                        // æ›´æ–°åç»­æ—¥æœŸ
                        if (currentIndex >= 0 && currentIndex < allDateElements.length - 1) {
                            let nextDate = newValue;
                            for (let i = currentIndex + 1; i < allDateElements.length; i++) {
                                nextDate = getNextDay(nextDate);
                                allDateElements[i].textContent = formatDateToMonthDay(nextDate);
                                allDateElements[i].dataset.date = nextDate;
                            }
                        }
                    } else {
                        dateElement.textContent = formatDateToMonthDay(newValue);
                        dateElement.dataset.date = newValue;
                    }
                }
            }
        }
        
        // æ›¿æ¢åŸæ¥çš„è¡Œå·ç›¸å…³å‡½æ•°
        function getRowNumber(rowIndex) {
            // è¿”å›ä»Šå¤©çš„æ—¥æœŸä½œä¸ºé»˜è®¤å€¼
            const today = new Date();
            return today.toISOString().split('T')[0];
        }
        
        // æ›´æ–°æ‰€æœ‰è¡Œå·å‡½æ•°ä¸å†éœ€è¦ï¼Œä½†ä¿ç•™ç©ºå‡½æ•°ä»¥é¿å…é”™è¯¯
        function updateRowNumbers() {
            // ä¸å†éœ€è¦æ›´æ–°è¡Œå·
        }
        
        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾å‡½æ•°
        function addCustomTag(inputId, columnId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ•°å­—ï¼ˆæ•´æ•°æˆ–ä¸€ä½å°æ•°ï¼‰
            const numberPattern = /^-?\d+(\.\d)?$/;
            if (value && numberPattern.test(value)) {
                const column = document.getElementById(columnId + '-content');
                // è·å–è¯¥åˆ—çš„æœ€æ–°è¡Œ
                const cells = column.querySelectorAll('.cell');
                const latestCell = cells[cells.length - 1];
                
                // å¦‚æœæ²¡æœ‰è¡Œï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæ–°è¡Œ
                if (!latestCell) {
                    addNewRow();
                    // é‡æ–°è·å–æœ€æ–°è¡Œ
                    const newCells = column.querySelectorAll('.cell');
                    const newLatestCell = newCells[newCells.length - 1];
                    addTagToCell(newLatestCell, value);
                } else {
                    addTagToCell(latestCell, value);
                }
                
                input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼ˆæ•´æ•°æˆ–ä¿ç•™ä¸€ä½å°æ•°ï¼‰');
            }
        }

        // æ·»åŠ æ ‡ç­¾åˆ°å•å…ƒæ ¼çš„è¾…åŠ©å‡½æ•°
        function addTagToCell(cell, value) {
            const newTag = document.createElement('div');
            newTag.className = 'number-tag';
            newTag.textContent = value;
            newTag.dataset.value = value;
            
            // ä¸ºæ ‡ç­¾æ·»åŠ å”¯ä¸€IDï¼Œä»¥ä¾¿åç»­å¼•ç”¨
            newTag.id = 'tag-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            
            // æ ¹æ®å•å…ƒæ ¼æ‰€åœ¨åˆ—å†³å®šæ˜¯å¦å¯æ‹–åŠ¨
            if(cell.id && cell.id.startsWith('cell3')) {
                newTag.draggable = false;
                // æ·»åŠ è§†è§‰æç¤ºï¼Œè¡¨æ˜ä¸å¯æ‹–åŠ¨
                newTag.style.cursor = 'default';
                newTag.title = 'ç‚¹å‡»åˆ é™¤æŒ‰é’®ç§»é™¤';
            } else {
                newTag.draggable = true;
            }
            
            // æ·»åŠ æ‹–æ‹½äº‹ä»¶ï¼ˆåªæœ‰éç¬¬ä¸‰åˆ—çš„æ ‡ç­¾å¯æ‹–åŠ¨ï¼‰
            if(newTag.draggable) {
                newTag.addEventListener('dragstart', function(e) {
                    if (!newTag.classList.contains('editing') && !newTag.classList.contains('used')) {
                        e.dataTransfer.setData('text/plain', newTag.dataset.value);
                        e.dataTransfer.setData('sourceId', newTag.id);
                        // å­˜å‚¨å½“å‰æ‹–åŠ¨çš„æ ‡ç­¾IDåˆ°å…¨å±€å˜é‡
                        window.currentDragSourceId = newTag.id;
                    } else {
                        e.preventDefault();
                    }
                });
                
                newTag.addEventListener('dragend', function() {
                    // æ¸…é™¤å…¨å±€å˜é‡
                    window.currentDragSourceId = null;
                });
            }

            // æ·»åŠ åŒå‡»ç¼–è¾‘åŠŸèƒ½
            newTag.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                if (!newTag.classList.contains('editing')) {
                    newTag.classList.add('editing');
                    const wasDraggable = newTag.draggable;
                    newTag.draggable = false;
                    const currentValue = newTag.textContent;
                    newTag.textContent = '';
                    
                    const editor = document.createElement('input');
                    editor.type = 'text'; // æ”¹ä¸ºtextç±»å‹ä»¥æ”¯æŒå°æ•°
                    editor.value = currentValue;
                    editor.style.width = '60px';
                    editor.style.padding = '5px';
                    editor.style.border = 'none';
                    editor.style.borderRadius = '3px';
                    editor.style.backgroundColor = 'white';
                    editor.style.color = '#333';
                    
                    editor.addEventListener('blur', finishEditing);
                    editor.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            finishEditing();
                        }
                    });
                    
                    function finishEditing() {
                        const newValue = editor.value.trim();
                        // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ•°å­—ï¼ˆæ•´æ•°æˆ–ä¸€ä½å°æ•°ï¼‰
                        const numberPattern = /^-?\d+(\.\d)?$/;
                        if (newValue && numberPattern.test(newValue)) {
                            newTag.textContent = newValue;
                            newTag.dataset.value = newValue;
                            // å¦‚æœåœ¨ç¬¬ä¸‰åˆ—ä¸­ï¼Œæ›´æ–°æ€»å’Œ
                            const parentCell = newTag.closest('.cell');
                            if (parentCell && parentCell.id.startsWith('cell3')) {
                                updateSum(parentCell);
                            }
                        } else {
                            newTag.textContent = currentValue;
                            if (newValue !== '') {
                                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼ˆæ•´æ•°æˆ–ä¿ç•™ä¸€ä½å°æ•°ï¼‰');
                            }
                        }
                        newTag.classList.remove('editing');
                        newTag.draggable = wasDraggable; // æ¢å¤åŸæ¥çš„æ‹–æ‹½çŠ¶æ€
                    }
                    
                    newTag.appendChild(editor);
                    editor.focus();
                }
            });

            // æ·»åŠ åˆ é™¤åŠŸèƒ½
            newTag.addEventListener('click', function(e) {
                const rect = newTag.getBoundingClientRect();
                const isClickOnDeleteButton = 
                    e.clientX >= rect.right - 20 && 
                    e.clientX <= rect.right + 10 && 
                    e.clientY >= rect.top - 10 && 
                    e.clientY <= rect.top + 20;

                if (isClickOnDeleteButton) {
                    e.stopPropagation();
                    
                    // å¦‚æœåœ¨ç¬¬ä¸‰åˆ—ä¸­è¢«åˆ é™¤ï¼Œæ¢å¤æºæ ‡ç­¾çš„æ‹–åŠ¨åŠŸèƒ½
                    const parentCell = newTag.closest('.cell');
                    if (parentCell && parentCell.id.startsWith('cell3') && newTag.dataset.sourceId) {
                        const sourceTag = document.getElementById(newTag.dataset.sourceId);
                        if(sourceTag) {
                            sourceTag.draggable = true;
                            sourceTag.classList.remove('used');
                            sourceTag.style.opacity = '1';
                            sourceTag.style.cursor = 'move';
                            sourceTag.title = '';
                            delete sourceTag.dataset.linkedId;
                        }
                    }
                    
                    newTag.remove();
                    // å¦‚æœåœ¨ç¬¬ä¸‰åˆ—ä¸­ï¼Œæ›´æ–°æ€»å’Œ
                    if (parentCell && parentCell.id.startsWith('cell3')) {
                        updateSum(parentCell);
                    }
                }
            });
            
            // å¦‚æœæ˜¯ç¬¬ä¸‰åˆ—çš„å•å…ƒæ ¼ï¼Œåœ¨sum-displayå‰æ’å…¥
            const sumDisplay = cell.querySelector('.sum-display');
            if (sumDisplay) {
                cell.insertBefore(newTag, sumDisplay);
                updateSum(cell);
            } else {
                cell.appendChild(newTag);
            }
        }
        
        // åˆå§‹åŒ–æ ‡é¢˜ç¼–è¾‘åŠŸèƒ½
        function initTitleEditing() {
            const editableTitles = document.querySelectorAll('.editable-title');
            
            editableTitles.forEach(title => {
                title.addEventListener('click', function() {
                    // å¦‚æœå·²ç»åœ¨ç¼–è¾‘ä¸­ï¼Œä¸åšä»»ä½•æ“ä½œ
                    if (title.classList.contains('editing')) {
                        return;
                    }
                    
                    // ä¿å­˜åŸå§‹æ–‡æœ¬
                    const originalText = title.textContent;
                    title.classList.add('editing');
                    
                    // åˆ›å»ºè¾“å…¥æ¡†
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = originalText;
                    input.style.width = '100%';
                    input.style.fontSize = '1.5em';
                    input.style.fontWeight = 'bold';
                    input.style.padding = '5px';
                    input.style.border = 'none';
                    input.style.outline = 'none';
                    input.style.backgroundColor = 'transparent';
                    
                    // æ¸…ç©ºæ ‡é¢˜å†…å®¹å¹¶æ·»åŠ è¾“å…¥æ¡†
                    title.textContent = '';
                    title.appendChild(input);
                    input.focus();
                    
                    // å¤„ç†è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹äº‹ä»¶
                    input.addEventListener('blur', finishEditing);
                    
                    // å¤„ç†å›è½¦é”®
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            finishEditing();
                        }
                    });
                    
                    // å®Œæˆç¼–è¾‘çš„å‡½æ•°
                    function finishEditing() {
                        const newText = input.value.trim();
                        title.classList.remove('editing');
                        
                        // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ¢å¤åŸå§‹æ–‡æœ¬
                        if (newText === '') {
                            title.textContent = originalText;
                        } else {
                            title.textContent = newText;
                        }
                    }
                });
            });
        }

        // æ·»åŠ åˆ é™¤æ•´è¡Œçš„å‡½æ•°
        function deleteEntireRow(rowId) {
            // ç¡®è®¤æ˜¯å¦åˆ é™¤
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€è¡Œå—ï¼Ÿè¿™å°†åˆ é™¤è¯¥è¡Œçš„æ‰€æœ‰å†…å®¹ã€‚')) {
                // åˆ é™¤è¡Œç»„
                const rowGroup = document.getElementById(`row-group-${rowId}`);
                if (rowGroup) {
                    rowGroup.remove();
                }
                
                // åˆ é™¤ç¬¬ä¸€åˆ—å•å…ƒæ ¼
                const cell1 = document.getElementById(`cell1-${rowId}`);
                if (cell1) {
                    // æ‰¾åˆ°æ‰€æœ‰æ ‡ç­¾ï¼Œæ¢å¤è¢«ä½¿ç”¨çš„æ ‡ç­¾
                    const tags = cell1.querySelectorAll('.number-tag');
                    tags.forEach(tag => {
                        if (tag.dataset.linkedId) {
                            // æ‰¾åˆ°ç¬¬ä¸‰åˆ—ä¸­å¯¹åº”çš„æ ‡ç­¾å¹¶åˆ é™¤
                            const linkedTags = document.querySelectorAll(`.number-tag[data-linked-id="${tag.dataset.linkedId}"]`);
                            linkedTags.forEach(linkedTag => {
                                if (linkedTag !== tag) {
                                    const parentCell = linkedTag.closest('.cell');
                                    linkedTag.remove();
                                    if (parentCell && parentCell.id.startsWith('cell3')) {
                                        updateSum(parentCell);
                                    }
                                }
                            });
                        }
                    });
                    cell1.remove();
                }
                
                // åˆ é™¤ç¬¬äºŒåˆ—å•å…ƒæ ¼
                const cell2 = document.getElementById(`cell2-${rowId}`);
                if (cell2) {
                    // æ‰¾åˆ°æ‰€æœ‰æ ‡ç­¾ï¼Œæ¢å¤è¢«ä½¿ç”¨çš„æ ‡ç­¾
                    const tags = cell2.querySelectorAll('.number-tag');
                    tags.forEach(tag => {
                        if (tag.dataset.linkedId) {
                            // æ‰¾åˆ°ç¬¬ä¸‰åˆ—ä¸­å¯¹åº”çš„æ ‡ç­¾å¹¶åˆ é™¤
                            const linkedTags = document.querySelectorAll(`.number-tag[data-linked-id="${tag.dataset.linkedId}"]`);
                            linkedTags.forEach(linkedTag => {
                                if (linkedTag !== tag) {
                                    const parentCell = linkedTag.closest('.cell');
                                    linkedTag.remove();
                                    if (parentCell && parentCell.id.startsWith('cell3')) {
                                        updateSum(parentCell);
                                    }
                                }
                            });
                        }
                    });
                    cell2.remove();
                }
                
                // åˆ é™¤ç¬¬ä¸‰åˆ—å•å…ƒæ ¼
                const cell3 = document.getElementById(`cell3-${rowId}`);
                if (cell3) {
                    cell3.remove();
                }
                
                // é‡æ–°æ’åˆ—å‰©ä½™è¡Œçš„ID
                reorderRows();
            }
        }
        
        // é‡æ–°æ’åˆ—è¡ŒIDçš„å‡½æ•°
        function reorderRows() {
            // è·å–æ‰€æœ‰è¡Œç»„
            const rowGroups = document.querySelectorAll('.row-group');
            
            // è·å–æ‰€æœ‰å•å…ƒæ ¼
            const cells1 = document.querySelectorAll('#column1-content .cell');
            const cells2 = document.querySelectorAll('#column2-content .cell');
            const cells3 = document.querySelectorAll('#column3-content .cell');
            
            // é‡æ–°åˆ†é…ID
            for (let i = 0; i < rowGroups.length; i++) {
                const newRowId = i + 1;
                
                // æ›´æ–°è¡Œç»„
                const rowGroup = rowGroups[i];
                rowGroup.id = `row-group-${newRowId}`;
                rowGroup.dataset.rowId = newRowId;
                
                // æ›´æ–°æ—¥æœŸå…ƒç´ 
                const dateElement = rowGroup.querySelector('.row-number');
                if (dateElement) {
                    dateElement.id = `row-number-${newRowId}`;
                    dateElement.dataset.rowId = newRowId;
                }
                
                // æ›´æ–°ç¬¬ä¸€åˆ—å•å…ƒæ ¼
                if (i < cells1.length) {
                    const cell = cells1[i];
                    cell.id = `cell1-${newRowId}`;
                    cell.dataset.rowId = newRowId;
                }
                
                // æ›´æ–°ç¬¬äºŒåˆ—å•å…ƒæ ¼
                if (i < cells2.length) {
                    const cell = cells2[i];
                    cell.id = `cell2-${newRowId}`;
                    cell.dataset.rowId = newRowId;
                }
                
                // æ›´æ–°ç¬¬ä¸‰åˆ—å•å…ƒæ ¼
                if (i < cells3.length) {
                    const cell = cells3[i];
                    cell.id = `cell3-${newRowId}`;
                    cell.dataset.rowId = newRowId;
                }
            }
        }

        // æ·»åŠ é€šè¿‡é¼ æ ‡ç‚¹å‡»åˆ›å»ºæ ‡ç­¾çš„å‡½æ•°
        function promptAndAddTag(cell, columnNumber) {
            // ç§»é™¤ä»»ä½•å·²å­˜åœ¨çš„è‡ªå®šä¹‰è¾“å…¥æ¡†
            const existingPopup = document.querySelector('.custom-input-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // åˆ›å»ºè‡ªå®šä¹‰è¾“å…¥æ¡†
            const popup = document.createElement('div');
            popup.className = 'custom-input-popup';
            
            // è·å–å•å…ƒæ ¼çš„ä½ç½®ä¿¡æ¯
            const cellRect = cell.getBoundingClientRect();
            
            // æ£€æŸ¥å•å…ƒæ ¼å†…æ˜¯å¦å·²æœ‰æ ‡ç­¾
            const existingTags = cell.querySelectorAll('.number-tag');
            
            // è®¡ç®—è¾“å…¥æ¡†çš„ä½ç½®ï¼Œé¿å…é®æŒ¡å·²æœ‰æ ‡ç­¾
            let popupLeft = cellRect.left + 20;
            let popupTop = cellRect.top + window.scrollY + 20;
            
            // å¦‚æœæœ‰å·²å­˜åœ¨çš„æ ‡ç­¾ï¼Œè°ƒæ•´ä½ç½®
            if (existingTags.length > 0) {
                // è·å–æœ€åä¸€ä¸ªæ ‡ç­¾çš„ä½ç½®
                const lastTag = existingTags[existingTags.length - 1];
                const lastTagRect = lastTag.getBoundingClientRect();
                
                // è®¡ç®—æ–°ä½ç½®
                if (lastTagRect.right + 150 < cellRect.right) {
                    // å¦‚æœå³ä¾§æœ‰è¶³å¤Ÿç©ºé—´ï¼Œæ”¾åœ¨æœ€åä¸€ä¸ªæ ‡ç­¾çš„å³ä¾§
                    popupLeft = lastTagRect.right + 10;
                    popupTop = lastTagRect.top + window.scrollY;
                } else if (lastTagRect.bottom + 100 < cellRect.bottom) {
                    // å¦‚æœä¸‹æ–¹æœ‰è¶³å¤Ÿç©ºé—´ï¼Œæ”¾åœ¨æœ€åä¸€ä¸ªæ ‡ç­¾çš„ä¸‹æ–¹
                    popupLeft = lastTagRect.left;
                    popupTop = lastTagRect.bottom + window.scrollY + 10;
                } else {
                    // å¦‚æœå•å…ƒæ ¼å†…ç©ºé—´ä¸è¶³ï¼Œæ”¾åœ¨å•å…ƒæ ¼å¤–éƒ¨çš„å³ä¾§
                    popupLeft = cellRect.right + 10;
                    popupTop = cellRect.top + window.scrollY;
                }
            }
            
            // ç¡®ä¿è¾“å…¥æ¡†ä¸ä¼šè¶…å‡ºè§†å£
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // ä¼°è®¡è¾“å…¥æ¡†çš„å®½åº¦å’Œé«˜åº¦
            const popupWidth = 200;
            const popupHeight = 120;
            
            // è°ƒæ•´æ°´å¹³ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå³è¾¹ç•Œ
            if (popupLeft + popupWidth > viewportWidth - 20) {
                popupLeft = viewportWidth - popupWidth - 20;
            }
            
            // è°ƒæ•´å‚ç›´ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºä¸‹è¾¹ç•Œ
            if (popupTop + popupHeight > viewportHeight + window.scrollY - 20) {
                popupTop = viewportHeight + window.scrollY - popupHeight - 20;
            }
            
            // è®¾ç½®è¾“å…¥æ¡†ä½ç½®
            popup.style.left = `${popupLeft}px`;
            popup.style.top = `${popupTop}px`;
            
            // åˆ›å»ºæ ‡é¢˜
            const title = document.createElement('div');
            title.textContent = 'è¯·è¾“å…¥æ•°å­—ï¼ˆæ•´æ•°æˆ–ä¿ç•™ä¸€ä½å°æ•°ï¼‰ï¼š';
            title.style.marginBottom = '10px';
            title.style.fontWeight = 'bold';
            
            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'ä¾‹å¦‚: 10 æˆ– 5.5';
            
            // åˆ›å»ºæŒ‰é’®å®¹å™¨
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'buttons';
            
            // åˆ›å»ºç¡®è®¤æŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'confirm-btn';
            confirmBtn.textContent = 'ç¡®è®¤';
            
            // åˆ›å»ºå–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-btn';
            cancelBtn.textContent = 'å–æ¶ˆ';
            
            // æ·»åŠ æŒ‰é’®åˆ°å®¹å™¨
            buttonsDiv.appendChild(confirmBtn);
            buttonsDiv.appendChild(cancelBtn);
            
            // ç»„è£…è¾“å…¥æ¡†
            popup.appendChild(title);
            popup.appendChild(input);
            popup.appendChild(buttonsDiv);
            
            // æ·»åŠ åˆ°æ–‡æ¡£
            document.body.appendChild(popup);
            
            // èšç„¦è¾“å…¥æ¡†
            input.focus();
            
            // ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            confirmBtn.addEventListener('click', function() {
                const value = input.value.trim();
                validateAndAddTag(value);
            });
            
            // å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            cancelBtn.addEventListener('click', function() {
                popup.remove();
            });
            
            // è¾“å…¥æ¡†å›è½¦é”®äº‹ä»¶
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const value = input.value.trim();
                    validateAndAddTag(value);
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­è¾“å…¥æ¡†
            document.addEventListener('click', function closePopup(e) {
                if (!popup.contains(e.target) && e.target !== cell) {
                    popup.remove();
                    document.removeEventListener('click', closePopup);
                }
            });
            
            // éªŒè¯è¾“å…¥å¹¶æ·»åŠ æ ‡ç­¾
            function validateAndAddTag(value) {
                // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ•°å­—ï¼ˆæ•´æ•°æˆ–ä¸€ä½å°æ•°ï¼‰
                const numberPattern = /^-?\d+(\.\d)?$/;
                if (value && numberPattern.test(value)) {
                    addTagToCell(cell, value);
                    popup.remove();
                } else if (value !== '') {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼ˆæ•´æ•°æˆ–ä¿ç•™ä¸€ä½å°æ•°ï¼‰');
                    input.focus();
                }
            }
        }
        
        // æ·»åŠ æ»šåŠ¨åŒæ­¥åŠŸèƒ½
        function initScrollSync() {
            const columnContents = [
                document.querySelector('#row-numbers-content'),
                document.querySelector('#variety-content'),
                document.querySelector('#column1-content'),
                document.querySelector('#column2-content'),
                document.querySelector('#column3-content')
            ];
            
            // ä¸ºæ¯ä¸ªåˆ—å†…å®¹åŒºåŸŸæ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨
            columnContents.forEach((content, index) => {
                if (content) {
                    content.addEventListener('scroll', function() {
                        // è·å–å½“å‰æ»šåŠ¨ä½ç½®
                        const scrollTop = this.scrollTop;
                        
                        // åŒæ­¥å…¶ä»–åˆ—çš„æ»šåŠ¨ä½ç½®
                        columnContents.forEach((otherContent, otherIndex) => {
                            if (otherContent && otherIndex !== index) {
                                // é˜²æ­¢æ— é™å¾ªç¯è§¦å‘æ»šåŠ¨äº‹ä»¶
                                if (otherContent.scrollTop !== scrollTop) {
                                    otherContent.scrollTop = scrollTop;
                                }
                            }
                        });
                    });
                }
            });
            
            // æ·»åŠ è¡Œé«˜äº®æ•ˆæœ
            document.addEventListener('mouseover', function(e) {
                const cell = e.target.closest('.cell');
                if (cell) {
                    const rowId = cell.dataset.rowId;
                    if (rowId) {
                        highlightRow(rowId);
                    }
                }
                
                const rowNumber = e.target.closest('.row-number');
                if (rowNumber) {
                    const rowId = rowNumber.dataset.rowId;
                    if (rowId) {
                        highlightRow(rowId);
                    }
                }
            });
            
            document.addEventListener('mouseout', function(e) {
                if (!e.relatedTarget || !e.relatedTarget.closest('.row-group, .cell')) {
                    // é¼ æ ‡ç§»å‡ºè¡ŒåŒºåŸŸï¼Œå–æ¶ˆé«˜äº®
                    clearRowHighlight();
                }
            });
        }
        
        // é«˜äº®æŒ‡å®šè¡Œ
        function highlightRow(rowId) {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            clearRowHighlight();
            
            // é«˜äº®è¡Œç»„
            const rowGroup = document.getElementById(`row-group-${rowId}`);
            if (rowGroup) {
                rowGroup.classList.add('highlight');
            }
            
            // é«˜äº®å•å…ƒæ ¼
            const cells = document.querySelectorAll(`.cell[data-row-id="${rowId}"]`);
            cells.forEach(cell => {
                cell.classList.add('highlight');
                cell.style.backgroundColor = '#e3f2fd';
                cell.style.borderColor = '#2196F3';
            });
            
            // é«˜äº®æ—¥æœŸ
            const rowNumber = document.getElementById(`row-number-${rowId}`);
            if (rowNumber) {
                rowNumber.classList.add('highlight');
                rowNumber.style.backgroundColor = '#e3f2fd';
                rowNumber.style.borderColor = '#2196F3';
            }
        }
        
        // æ¸…é™¤è¡Œé«˜äº®
        function clearRowHighlight() {
            // æ¢å¤è¡Œç»„æ ·å¼
            document.querySelectorAll('.row-group.highlight').forEach(group => {
                group.classList.remove('highlight');
            });
            
            // æ¢å¤å•å…ƒæ ¼æ ·å¼
            document.querySelectorAll('.cell.highlight').forEach(cell => {
                cell.classList.remove('highlight');
                
                // æ¢å¤åŸå§‹èƒŒæ™¯è‰²ï¼ˆæ ¹æ®å¥‡å¶è¡Œï¼‰
                const rowId = cell.dataset.rowId;
                if (rowId) {
                    const isOdd = parseInt(rowId) % 2 === 1;
                    cell.style.backgroundColor = isOdd ? '#f9f9f9' : '#f0f0f0';
                    cell.style.borderColor = '#ccc';
                }
            });
            
            // æ¢å¤æ—¥æœŸæ ·å¼
            document.querySelectorAll('.row-number.highlight').forEach(rowNumber => {
                rowNumber.classList.remove('highlight');
                
                // æ¢å¤åŸå§‹èƒŒæ™¯è‰²ï¼ˆæ ¹æ®å¥‡å¶è¡Œï¼‰
                const rowId = rowNumber.dataset.rowId;
                if (rowId) {
                    const isOdd = parseInt(rowId) % 2 === 1;
                    rowNumber.style.backgroundColor = isOdd ? '#f9f9f9' : '#f0f0f0';
                    rowNumber.style.borderColor = '#ccc';
                }
            });
        }

        // æ·»åŠ æ ¼å¼åŒ–æ—¶é—´çš„å‡½æ•°
        function formatDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}_${hours}${minutes}${seconds}`;
        }

        // å¯¼å‡ºåˆ°ExcelåŠŸèƒ½
        function exportToExcel() {
            // åˆ›å»ºä¸€ä¸ªå·¥ä½œè¡¨æ•°æ®æ•°ç»„
            let data = [];
            
            // è·å–ä¸»æ ‡é¢˜ä½œä¸ºæ–‡ä»¶å
            const mainTitle = document.getElementById('main-title').textContent;
            const timestamp = formatDateTime();
            
            // æ·»åŠ è¡¨å¤´
            const title1 = document.getElementById('title1').textContent;
            const title2 = document.getElementById('title2').textContent;
            data.push(['æ—¥æœŸ', 'å“ç§', title1, title2, 'åˆè®¡']); // æ·»åŠ å“ç§åˆ—æ ‡é¢˜
            
            // è·å–æ‰€æœ‰è¡Œ
            const rowGroups = document.querySelectorAll('.row-group');
            
            // éå†æ¯ä¸€è¡Œ
            rowGroups.forEach(rowGroup => {
                const rowId = rowGroup.dataset.rowId;
                
                // è·å–æ—¥æœŸ
                const dateElement = rowGroup.querySelector('.row-number');
                const date = dateElement ? dateElement.dataset.date : '';
                
                // è·å–å“ç§æ•°æ®
                const varietyCell = document.getElementById(`variety-cell-${rowId}`);
                const variety = varietyCell ? varietyCell.textContent : '';
                
                // è·å–ç¬¬ä¸€åˆ—æ•°æ®
                const cell1 = document.getElementById(`cell1-${rowId}`);
                const tags1 = cell1 ? Array.from(cell1.querySelectorAll('.number-tag')).map(tag => tag.dataset.value) : [];
                const values1 = tags1.join(', ');
                
                // è·å–ç¬¬äºŒåˆ—æ•°æ®
                const cell2 = document.getElementById(`cell2-${rowId}`);
                const tags2 = cell2 ? Array.from(cell2.querySelectorAll('.number-tag')).map(tag => tag.dataset.value) : [];
                const values2 = tags2.join(', ');
                
                // è·å–ç¬¬ä¸‰åˆ—æ•°æ®ï¼ˆåˆè®¡ï¼‰
                const cell3 = document.getElementById(`cell3-${rowId}`);
                const sumDisplay = cell3 ? cell3.querySelector('.sum-display').textContent : '';
                const sum = sumDisplay.replace('æ€»å’Œ: ', '');
                
                // æ·»åŠ è¡Œæ•°æ®
                data.push([date, variety, values1, values2, sum]); // æ·»åŠ å“ç§åˆ—æ•°æ®
            });
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡
            
            data.forEach(row => {
                const csvRow = row.map(cell => {
                    // å¦‚æœå•å…ƒæ ¼åŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œç¬¦ï¼Œåˆ™ç”¨å¼•å·åŒ…è£¹
                    if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                        return `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                }).join(',');
                csvContent += csvRow + '\r\n';
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `${mainTitle}_${timestamp}.csv`);
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            
            // æ¸…ç†
            document.body.removeChild(link);
        }

        // å¯¼å‡ºä¸ºå›¾ç‰‡åŠŸèƒ½
        function exportToImage() {
            // æ˜¾ç¤ºåŠ è½½ä¸­åŠ¨ç”»
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            
            const loadingSpinner = document.createElement('div');
            loadingSpinner.className = 'loading-spinner';
            
            const loadingContainer = document.createElement('div');
            loadingContainer.style.display = 'flex';
            loadingContainer.style.flexDirection = 'column';
            loadingContainer.style.alignItems = 'center';
            
            const loadingText = document.createElement('div');
            loadingText.className = 'loading-text';
            loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...';
            
            loadingContainer.appendChild(loadingSpinner);
            loadingContainer.appendChild(loadingText);
            loadingOverlay.appendChild(loadingContainer);
            document.body.appendChild(loadingOverlay);
            
            // è·å–è¦æˆªå›¾çš„å…ƒç´ 
            const container = document.querySelector('.container');
            const title = document.getElementById('main-title');
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼ŒåŒ…å«æ ‡é¢˜å’Œè¡¨æ ¼
            const tempContainer = document.createElement('div');
            tempContainer.style.backgroundColor = 'white';
            tempContainer.style.padding = '20px';
            tempContainer.style.width = container.offsetWidth + 'px';
            
            // å…‹éš†æ ‡é¢˜
            const titleClone = document.createElement('h1');
            titleClone.textContent = title.textContent;
            titleClone.style.textAlign = 'center';
            titleClone.style.marginBottom = '20px';
            
            // å°†å…‹éš†çš„æ ‡é¢˜æ·»åŠ åˆ°ä¸´æ—¶å®¹å™¨
            tempContainer.appendChild(titleClone);
            
            // å…‹éš†è¡¨æ ¼å®¹å™¨
            const containerClone = container.cloneNode(true);
            
            // ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½å¯è§ï¼ˆä¸å—æ»šåŠ¨é™åˆ¶ï¼‰
            const columnContents = containerClone.querySelectorAll('.column-content');
            columnContents.forEach(content => {
                content.style.maxHeight = 'none';
                content.style.overflow = 'visible';
            });
            
            // å°†å…‹éš†çš„è¡¨æ ¼æ·»åŠ åˆ°ä¸´æ—¶å®¹å™¨
            tempContainer.appendChild(containerClone);
            
            // å°†ä¸´æ—¶å®¹å™¨æ·»åŠ åˆ°æ–‡æ¡£ä¸­ï¼ˆä½†ä¸å¯è§ï¼‰
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            document.body.appendChild(tempContainer);
            
            // ä½¿ç”¨html2canvasæˆªå›¾
            setTimeout(() => {
                html2canvas(tempContainer, {
                    scale: 2, // æé«˜å›¾ç‰‡è´¨é‡
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    // ç§»é™¤ä¸´æ—¶å®¹å™¨
                    document.body.removeChild(tempContainer);
                    
                    // ç§»é™¤åŠ è½½ä¸­åŠ¨ç”»
                    document.body.removeChild(loadingOverlay);
                    
                    // å°†canvasè½¬æ¢ä¸ºå›¾ç‰‡
                    const image = canvas.toDataURL('image/png');
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = image;
                    const timestamp = formatDateTime();
                    link.download = `${title.textContent}_${timestamp}.png`;
                    link.click();
                }).catch(error => {
                    console.error('æˆªå›¾å¤±è´¥:', error);
                    alert('æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•');
                    
                    // ç§»é™¤ä¸´æ—¶å®¹å™¨
                    document.body.removeChild(tempContainer);
                    
                    // ç§»é™¤åŠ è½½ä¸­åŠ¨ç”»
                    document.body.removeChild(loadingOverlay);
                });
            }, 500); // ç»™æµè§ˆå™¨ä¸€äº›æ—¶é—´æ¥æ¸²æŸ“ä¸´æ—¶å®¹å™¨
        }
    </script>
</body>
</html>
